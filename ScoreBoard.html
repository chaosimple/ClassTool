<!DOCTYPE html>

<html>
<head>
<title>成绩榜单</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
        body { 
            font-family: 'Helvetica Neue', Arial, sans-serif; 
            max-width: 1200px; 
            margin: 20px auto; 
            padding: 30px; 
            background: #f8f9fa; 
            position: relative;
        }
        .title { 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .title h1 { 
            font-size: 2.5em; 
            color: #2c3e50; 
            margin: 0; 
        }
        .main-container {
            display: flex;
            gap: 30px;
            align-items: stretch; /* Align items to stretch vertically */
            position: relative; 
        }

        .left-card {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            
            display: flex;
            flex-direction: column;
        }
        
        .right-column {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* 优化后的收缩/展开按钮 */
        #toggle-btn {
            position: absolute;
            top: 50%;
            left: 0; /* 初始时在左侧 */
            transform: translate(-50%, -50%); /* 精准居中 */
            z-index: 10;
            width: 0;
            height: 0;
            border-left: 8px solid #2c3e50;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            background: none;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #toggle-btn:hover {
            opacity: 0.8;
        }
        
        .left-card.collapsed {
            flex: 0;
            min-width: 0;
            opacity: 0;
            transform: translateX(-110%); 
        }
        
        /* 收缩后，按钮移动到页面边缘 */
        .main-container.collapsed #toggle-btn {
           left: 15px; 
           border-left: 8px solid transparent;
           border-right: 8px solid #2c3e50;
        }

        .student-table-container {
            padding: 0 20px 20px;
            flex-grow: 1;
            overflow-y: auto;
            max-height: 480px;
        }
        
        .table-wrapper {
            border: 1px solid #eee;
            border-radius: 8px;
            
        }

        #studentInfoTable {
            width: 100%;
            border-collapse: collapse;
        }
        #studentInfoTable th, #studentInfoTable td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        #studentInfoTable thead {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: #f8f9fa;
        }
        #studentInfoTable th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f1f3f5;
            font-weight: bold;
        }

        .ranking-table { 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
             
        }
        .ranking-header { 
            background: linear-gradient(135deg, #3498db, #2c3e50); 
            color: white; 
            padding: 20px; 
            font-size: 1.5em; 
            text-align: center; 
        }
        .ranking-item { 
            display: flex; 
            align-items: center; 
            padding: 20px; 
            border-bottom: 1px solid #eee; 
            position: relative; 
        }
        .ranking-item:last-child {
            border-bottom: none;
        }
        .ranking-item:nth-child(1) { font-size: 1.8em; }
        .ranking-item:nth-child(2) { font-size: 1.6em; }
        .ranking-item:nth-child(3) { font-size: 1.4em; }
        .ranking-item:nth-child(4) { font-size: 1.2em; }
        .ranking-item:nth-child(5) { font-size: 1.1em; }
        .rank { width: 80px; font-weight: bold; text-align: center; }
        .medal-gold { color: #ffd700; }
        .medal-silver { color: #c0c0c0; }
        .medal-bronze { color: #cd7f32; }
        .medal-blue { color: #2980b9; }
        .medal-purple { color: #9b59b6; }
        .profile { flex: 1; margin-left: 30px; }
        .score { width: 120px; text-align: right; font-weight: bold; color: #3498db; }
        .input-section { 
            background: white; 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
        }
        .input-group { display: flex; gap: 15px; margin-bottom: 15px; }
        input { 
            flex: 1; 
            padding: 12px; 
            border: 2px solid #eee; 
            border-radius: 8px; 
            font-size: 16px; 
        }
        .button-group { 
            display: flex; 
            gap: 15px; 
            justify-content: center; 
            margin-top: 20px; 
        }
        button { 
            padding: 12px 30px; 
            background: linear-gradient(135deg, #3498db, #2c3e50); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
        }
        button:hover { opacity: 0.9; }
        .delete-btn { 
            position: absolute; 
            right: 20px; 
            color: #e74c3c; 
            cursor: pointer; 
            font-size: 0.8em; 
            opacity: 0.7; 
        }
        .delete-btn:hover { opacity: 1; }
        .error { 
            color: #e74c3c; 
            text-align: center; 
            margin-top: 10px; 
        }
        .file-input { margin: 20px; text-align: center; }
        .spacer { width: 80px; }
    </style>
</head>
<body>
<div class="title">
<h1 id="dynamicTitle"></h1>
</div>
<div class="main-container" id="mainContainer">
<div class="left-card" id="leftCard">
<div class="ranking-header">👨‍🎓 学生信息</div>
<div class="file-input">
<input accept=".xlsx, .xls, .csv" id="excelFile" type="file"/>
<!-- <p>请选择包含学号和姓名的文件</p> -->
</div>
<div class="student-table-container">
<div class="table-wrapper">
<table id="studentInfoTable">
<thead>
<tr>
<th>编号</th>
<th>学号</th>
<th>姓名</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
</div>
<div class="right-column">
<button id="toggle-btn" onclick="toggleLeftCard()"></button>
<div class="ranking-table">
<div class="ranking-header">🏆 成绩 TOP5</div>
<div id="rankingBody"></div>
</div>
<div class="input-section">
<div class="input-group">
<input autofocus="" id="studentId" placeholder="请输入学号" type="text"/>
<input id="score" placeholder="请输入成绩（如 83.25）" step="0.01" type="number"/>
</div>
<div class="button-group">
<button onclick="addScore()">提交成绩</button>
<button onclick="exportScores()">导出成绩</button>
<button onclick="clearAllRecords()">清空列表</button>
</div>
<div class="error" id="error"></div>
</div>
</div>
</div>
<script>
        let studentDatabase = {};
        let students = JSON.parse(localStorage.getItem('scores')) || [];

        // Function to format date
        function formatDateToYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Update the title on page load
        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const formattedDate = formatDateToYYYYMMDD(now);
            document.getElementById('dynamicTitle').textContent = `⛪️ ${formattedDate} 课堂成绩`;
        });

        // 读取Excel文件
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                studentDatabase = {};
                jsonData.forEach(row => {
                    const id = String(row['学号']);
                    studentDatabase[id] = row['姓名'];
                });
                
                displayStudentInfo(jsonData);
                alert(`成功加载${Object.keys(studentDatabase).length}条学生数据`);
            };

            reader.readAsArrayBuffer(file);
        });
        
        function displayStudentInfo(data) {
            const tableBody = document.querySelector("#studentInfoTable tbody");
            tableBody.innerHTML = ''; 

            if(!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#888; padding: 20px;">无数据</td></tr>';
                return;
            }

            data.forEach((row, index) => {
                const studentId = row['学号'] || 'N/A';
                const studentName = row['姓名'] || 'N/A';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${studentId}</td>
                    <td>${studentName}</td>
                `;
                tableBody.appendChild(tr);
            });
        }
        
        function toggleLeftCard() {
            const leftCard = document.getElementById('leftCard');
            const mainContainer = document.getElementById('mainContainer');
            
            leftCard.classList.toggle('collapsed');
            mainContainer.classList.toggle('collapsed');
        }

        document.getElementById('studentId').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') document.getElementById('score').focus()
        });
        
        document.getElementById('score').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') addScore()
        });

        function addScore() {
            const studentId = document.getElementById('studentId').value;
            const score = parseFloat(document.getElementById('score').value);
            const errorDiv = document.getElementById('error');
            
            errorDiv.textContent = '';

            if (!studentId || isNaN(score)) {
                showError("请填写有效的学号和成绩");
                return;
            }

            if (Object.keys(studentDatabase).length === 0) {
                 showError("请先加载学生信息文件");
                return;
            }
            if (!studentDatabase[studentId]) {
                showError("学号不存在，请核对");
                return;
            }

            const existingStudentIndex = students.findIndex(s => s.id === studentId);
            
            if (existingStudentIndex !== -1) {
                const existingScore = students[existingStudentIndex].score;
                
                if (score > existingScore) {
                    students[existingStudentIndex].score = score;
                    students[existingStudentIndex].timestamp = new Date(); // Update timestamp
                    alert(`更新成功！该学生的成绩从 ${existingScore.toFixed(2)} 提高到 ${score.toFixed(2)}`);
                } else {
                    showError("系统中已经有更高的成绩了！");
                    return;
                }
            } else {
                students.push({
                    id: studentId,
                    name: studentDatabase[studentId],
                    score: score,
                    timestamp: new Date() // Add timestamp for new record
                });
            }

            updateData();
            
            document.getElementById('studentId').value = '';
            document.getElementById('score').value = '';
            document.getElementById('studentId').focus();
        }

        function showError(message) {
            document.getElementById('error').textContent = message;
        }

        function clearAllRecords() {
            if (confirm("确定要清空所有记录吗？")) {
                students = [];
                localStorage.removeItem('scores');
                updateData();
                alert("所有记录已清空！");
            }
        }

        function updateData() {
            students.sort((a, b) => b.score - a.score);
            localStorage.setItem('scores', JSON.stringify(students));
            updateRanking();
        }

        function updateRanking() {
            const top5 = students.slice(0, 5);
            const container = document.getElementById('rankingBody');
            container.innerHTML = '';

            if (top5.length === 0) {
                 container.innerHTML = '<div style="text-align:center; padding: 40px; color: #888;">暂无成绩记录</div>';
            } else {
                top5.forEach((student, index) => {
                    const rank = index + 1;
                    const item = document.createElement('div');
                    item.className = 'ranking-item';

                    item.innerHTML = `
                        <div class="rank ${getMedalClass(rank)}">
                            ${rank}${getMedalSymbol(rank)}
                        </div>
                        <div class="profile">
                            <div>${student.name}</div>
                            <div style="color: #888; font-size: 0.8em;">学号：${student.id}</div>
                        </div>
                        <div class="score">${student.score.toFixed(2)}</div>
                        <div class="spacer"></div>
                        <div class="delete-btn" onclick="deleteRecord('${student.id}', ${student.score})">× 删除</div>
                    `;
                    container.appendChild(item);
                });
            }
        }

        function deleteRecord(id, score) {
            students = students.filter(s => !(s.id === id && s.score === score));
            updateData();
        }

        function getMedalClass(rank) {
            return [
                'medal-gold',
                'medal-silver',
                'medal-bronze',
                'medal-blue',
                'medal-purple'
            ][rank - 1] || '';
        }

        function getMedalSymbol(rank) {
            return ['🥇', '🥈', '🥉', '🎖️', '⭐'][rank - 1] || '';
        }

        function exportScores() {
            if (students.length === 0) {
                showError("没有成绩记录可以导出");
                return;
            }
            
            function formatDate(date) {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = (d.getMonth() + 1).toString().padStart(2, '0');
                const day = d.getDate().toString().padStart(2, '0');
                const hour = d.getHours().toString().padStart(2, '0');
                const minute = d.getMinutes().toString().padStart(2, '0');
                const second = d.getSeconds().toString().padStart(2, '0');
                return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
            }

            const ws = XLSX.utils.json_to_sheet(students.map((student, index) => ({
                '排名': index + 1,
                '学号': student.id,
                '姓名': student.name,
                '成绩': student.score.toFixed(2),
                '记录时间': student.timestamp ? formatDate(student.timestamp) : 'N/A'
            })));

            const colWidths = [
                { wch: 8 },
                { wch: 12 },
                { wch: 15 },
                { wch: 10 },
                { wch: 20 }
            ];
            ws['!cols'] = colWidths;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '成绩');

            const now = new Date();
            const fileName = `成绩_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}.xlsx`;

            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            
            setTimeout(() => {
                URL.revokeObjectURL(url);
                a.remove();
            }, 100);
        }

        // 初始化
        updateRanking();
        displayStudentInfo([]);
    </script>
</body>
</html>