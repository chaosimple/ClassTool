<!DOCTYPE html>
<html>
<head>
    <title>ÊàêÁª©Ê¶úÂçï</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { 
            font-family: 'Helvetica Neue', Arial, sans-serif; 
            max-width: 800px; 
            margin: 20px auto; 
            padding: 30px; 
            background: #f8f9fa; 
        }
        .title { 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .title h1 { 
            font-size: 2.5em; 
            color: #2c3e50; 
            margin: 0; 
            background: linear-gradient(135deg, #3498db, #2c3e50); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        .ranking-table { 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            overflow: hidden; 
            margin-bottom: 30px; 
        }
        .ranking-header { 
            background: linear-gradient(135deg, #3498db, #2c3e50); 
            color: white; 
            padding: 20px; 
            font-size: 1.5em; 
            text-align: center; 
        }
        .ranking-item { 
            display: flex; 
            align-items: center; 
            padding: 20px; 
            border-bottom: 1px solid #eee; 
            position: relative; 
        }
        .ranking-item:nth-child(1) { font-size: 1.8em; }
        .ranking-item:nth-child(2) { font-size: 1.6em; }
        .ranking-item:nth-child(3) { font-size: 1.4em; }
        .ranking-item:nth-child(4) { font-size: 1.2em; }
        .ranking-item:nth-child(5) { font-size: 1.1em; }
        .rank { width: 80px; font-weight: bold; text-align: center; }
        .medal-gold { color: #ffd700; }
        .medal-silver { color: #c0c0c0; }
        .medal-bronze { color: #cd7f32; }
        .medal-blue { color: #2980b9; }
        .medal-purple { color: #9b59b6; }
        .profile { flex: 1; margin-left: 30px; }
        .score { width: 120px; text-align: right; font-weight: bold; color: #3498db; }
        .input-section { 
            background: white; 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
        }
        .input-group { display: flex; gap: 15px; margin-bottom: 15px; }
        input { 
            flex: 1; 
            padding: 12px; 
            border: 2px solid #eee; 
            border-radius: 8px; 
            font-size: 16px; 
        }
        .button-group { 
            display: flex; 
            gap: 15px; 
            justify-content: center; 
            margin-top: 20px; 
        }
        button { 
            padding: 12px 30px; 
            background: linear-gradient(135deg, #3498db, #2c3e50); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
        }
        button:hover { opacity: 0.9; }
        .delete-btn { 
            position: absolute; 
            right: 20px; 
            color: #e74c3c; 
            cursor: pointer; 
            font-size: 0.8em; 
            opacity: 0.7; 
        }
        .delete-btn:hover { opacity: 1; }
        .error { 
            color: #e74c3c; 
            text-align: center; 
            margin-top: 10px; 
        }
        .file-input { margin: 20px 0; text-align: center; }
        .spacer { width: 80px; } /* Á©∫ÁôΩÂç†‰ΩçÁ¨¶ */
    </style>
</head>
<body>
    <div class="title">
        <h1>üìä ÊàêÁª©Ê¶úÂçï</h1>
    </div>

    <div class="file-input">
        <input type="file" id="excelFile" accept=".xlsx">
        <p>ËØ∑ÈÄâÊã©1.xlsxÊñá‰ª∂</p>
    </div>

    <div class="ranking-table">
        <div class="ranking-header">üèÜ ÊàêÁª© TOP5</div>
        <div id="rankingBody"></div>
    </div>

    <div class="input-section">
        <div class="input-group">
            <input type="text" id="studentId" placeholder="ËØ∑ËæìÂÖ•Â≠¶Âè∑" autofocus>
            <input type="number" id="score" step="0.01" placeholder="ËØ∑ËæìÂÖ•ÊàêÁª©ÔºàÂ¶Ç 83.25Ôºâ">
        </div>
        <div class="button-group">
            <button onclick="addScore()">Êèê‰∫§ÊàêÁª©</button>
            <button onclick="exportScores()">ÂØºÂá∫ÊàêÁª©</button>
            <button onclick="clearAllRecords()">Ê∏ÖÁ©∫</button>
        </div>
        <div id="error" class="error"></div>
    </div>

    <script>
        let studentDatabase = {};
        let students = JSON.parse(localStorage.getItem('scores')) || [];

        // ËØªÂèñExcelÊñá‰ª∂
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                studentDatabase = {};
                jsonData.forEach(row => {
                    const id = String(row['Â≠¶Âè∑']);
                    studentDatabase[id] = row['ÂßìÂêç'];
                });

                alert(`ÊàêÂäüÂä†ËΩΩ${Object.keys(studentDatabase).length}Êù°Â≠¶ÁîüÊï∞ÊçÆ`);
            };

            reader.readAsArrayBuffer(file);
        });

        // ËæìÂÖ•Ê°ÜÂõûËΩ¶‰∫ã‰ª∂
        document.getElementById('studentId').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') document.getElementById('score').focus()
        });
        
        document.getElementById('score').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') addScore()
        });

        function addScore() {
            const studentId = document.getElementById('studentId').value;
            const score = parseFloat(document.getElementById('score').value);
            const errorDiv = document.getElementById('error');
            
            errorDiv.textContent = '';

            if (!studentId || isNaN(score)) {
                showError("ËØ∑Â°´ÂÜôÊúâÊïàÁöÑÂ≠¶Âè∑ÂíåÊàêÁª©");
                return;
            }

            if (!studentDatabase[studentId]) {
                showError("Â≠¶Âè∑‰∏çÂ≠òÂú®");
                return;
            }

            // Ê£ÄÊü•ËØ•Â≠¶ÁîüÊòØÂê¶Â∑≤ÊúâÊàêÁª©
            const existingStudentIndex = students.findIndex(s => s.id === studentId);
            
            if (existingStudentIndex !== -1) {
                const existingScore = students[existingStudentIndex].score;
                
                if (score > existingScore) {
                    // Êõ¥Êñ∞ÊàêÁª©
                    students[existingStudentIndex].score = score;
                    alert(`Êõ¥Êñ∞ÊàêÂäüÔºÅËØ•Â≠¶ÁîüÁöÑÊàêÁª©‰ªé ${existingScore.toFixed(2)}% ÊèêÈ´òÂà∞ ${score.toFixed(2)}%`);
                } else {
                    showError("Á≥ªÁªü‰∏≠Â∑≤ÁªèÊúâÊõ¥È´òÁöÑÊàêÁª©‰∫ÜÔºÅ");
                    return;
                }
            } else {
                // Ê∑ªÂä†Êñ∞ÊàêÁª©
                students.push({
                    id: studentId,
                    name: studentDatabase[studentId],
                    score: score
                });
            }

            updateData();
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            document.getElementById('studentId').value = '';
            document.getElementById('score').value = '';
            document.getElementById('studentId').focus();
        }

        function showError(message) {
            document.getElementById('error').textContent = message;
        }

        function clearAllRecords() {
            if (confirm("Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâËÆ∞ÂΩïÂêóÔºü")) {
                students = [];
                localStorage.removeItem('scores');
                updateData();
                alert("ÊâÄÊúâËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫ÔºÅ");
            }
        }

        function updateData() {
            students.sort((a, b) => b.score - a.score);
            students = students.slice(0, 100);
            localStorage.setItem('scores', JSON.stringify(students));
            updateRanking();
        }

        function updateRanking() {
            const top5 = students.slice(0, 5);
            const container = document.getElementById('rankingBody');
            container.innerHTML = '';

            top5.forEach((student, index) => {
                const rank = index + 1;
                const item = document.createElement('div');
                item.className = 'ranking-item';

                item.innerHTML = `
                    <div class="rank ${getMedalClass(rank)}">
                        ${rank}${getMedalSymbol(rank)}
                    </div>
                    <div class="profile">
                        <div>${student.name}</div>
                        <div style="color: #888; font-size: 0.8em;">Â≠¶Âè∑Ôºö${student.id}</div>
                    </div>
                    <div class="score">${student.score.toFixed(2)}%</div>
                    <div class="spacer"></div>
                    <div class="delete-btn" onclick="deleteRecord('${student.id}', ${student.score})">√ó Âà†Èô§</div>
                `;
                container.appendChild(item);
            });
        }

        function deleteRecord(id, score) {
            students = students.filter(s => !(s.id === id && s.score === score));
            updateData();
        }

        function getMedalClass(rank) {
            return [
                'medal-gold',
                'medal-silver',
                'medal-bronze',
                'medal-blue',
                'medal-purple'
            ][rank - 1] || '';
        }

        function getMedalSymbol(rank) {
            return ['ü•á', 'ü•à', 'ü•â', 'üéñÔ∏è', '‚≠ê'][rank - 1] || '';
        }

        // ÂØºÂá∫ÊàêÁª©ÂäüËÉΩ
        function exportScores() {
            if (students.length === 0) {
                showError("Ê≤°ÊúâÊàêÁª©ËÆ∞ÂΩïÂèØ‰ª•ÂØºÂá∫");
                return;
            }

            // ÂàõÂª∫Â∑•‰ΩúÁ∞øÂíåÂ∑•‰ΩúË°®
            const ws = XLSX.utils.json_to_sheet(students.map((student, index) => ({
                'ÊéíÂêç': index + 1,
                'Â≠¶Âè∑': student.id,
                'ÂßìÂêç': student.name,
                'ÊàêÁª©': student.score.toFixed(2) + '%'
            })));

            // ËÆæÁΩÆÂàóÂÆΩ
            const colWidths = [
                { wch: 8 },  // ÊéíÂêç
                { wch: 12 }, // Â≠¶Âè∑
                { wch: 15 }, // ÂßìÂêç
                { wch: 10 }  // ÊàêÁª©
            ];
            ws['!cols'] = colWidths;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ÊàêÁª©');

            // ÁîüÊàêÊñá‰ª∂ÂêçÔºàÂ∏¶Êó∂Èó¥Êà≥Ôºâ
            const now = new Date();
            const fileName = `ÊàêÁª©_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}.xlsx`;

            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            
            // ÂàõÂª∫‰∏¥Êó∂ÈìæÊé•Âπ∂Ëß¶Âèë‰∏ãËΩΩ
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            
            // Ê∏ÖÁêÜ
            setTimeout(() => {
                URL.revokeObjectURL(url);
                a.remove();
            }, 100);
        }

        // ÂàùÂßãÂåñÊòæÁ§∫
        updateRanking();
    </script>
</body>
</html>
