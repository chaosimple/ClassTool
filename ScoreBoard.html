<!DOCTYPE html>
<html>
<head>
    <title>æˆç»©æ¦œå•</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 30px; background: #f8f9fa; }
        .title { text-align: center; margin-bottom: 30px; }
        .title h1 { font-size: 2.5em; color: #2c3e50; margin: 0; background: linear-gradient(135deg, #3498db, #2c3e50); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .ranking-table { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 30px; }
        .ranking-header { background: linear-gradient(135deg, #3498db, #2c3e50); color: white; padding: 20px; font-size: 1.5em; text-align: center; }
        .ranking-item { display: flex; align-items: center; padding: 20px; border-bottom: 1px solid #eee; position: relative; }
        .ranking-item:nth-child(1) { font-size: 1.8em; }
        .ranking-item:nth-child(2) { font-size: 1.6em; }
        .ranking-item:nth-child(3) { font-size: 1.4em; }
        .ranking-item:nth-child(4) { font-size: 1.2em; }
        .ranking-item:nth-child(5) { font-size: 1.1em; }
        .rank { width: 80px; font-weight: bold; text-align: center; }
        .medal-gold { color: #ffd700; }
        .medal-silver { color: #c0c0c0; }
        .medal-bronze { color: #cd7f32; }
        .medal-blue { color: #2980b9; }
        .medal-purple { color: #9b59b6; }
        .profile { flex: 1; margin-left: 30px; }
        .score { width: 120px; text-align: right; font-weight: bold; color: #3498db; }
        .input-section { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .input-group { display: flex; gap: 15px; margin-bottom: 15px; }
        input { flex: 1; padding: 12px; border: 2px solid #eee; border-radius: 8px; font-size: 16px; }
        .button-group { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        button { padding: 12px 30px; background: linear-gradient(135deg, #3498db, #2c3e50); color: white; border: none; border-radius: 8px; cursor: pointer; }
        button:hover { opacity: 0.9; }
        .delete-btn { position: absolute; right: 20px; color: #e74c3c; cursor: pointer; font-size: 0.8em; opacity: 0.7; }
        .delete-btn:hover { opacity: 1; }
        .error { color: #e74c3c; text-align: center; margin-top: 10px; }
        .file-input { margin: 20px 0; text-align: center; }
        /* æ·»åŠ ä¸€ä¸ªç©ºçš„divæ¥ä¸ºåˆ é™¤æŒ‰é’®ç•™å‡ºç©ºé—´ */
        .spacer { width: 80px; } /* æ–°å¢çš„æ ·å¼ */
    </style>
</head>
<body>
    <div class="title">
        <h1>ğŸ“Š æˆç»©æ¦œå•</h1>
    </div>

    <div class="file-input">
        <input type="file" id="excelFile" accept=".xlsx">
        <p>è¯·é€‰æ‹©1.xlsxæ–‡ä»¶</p>
    </div>

    <div class="ranking-table">
        <div class="ranking-header">ğŸ† æˆç»© TOP5</div>
        <div id="rankingBody"></div>
    </div>

    <div class="input-section">
        <div class="input-group">
            <input type="text" id="studentId" placeholder="è¯·è¾“å…¥å­¦å·" autofocus>
            <input type="number" id="score" step="0.01" placeholder="è¯·è¾“å…¥æˆç»©ï¼ˆå¦‚ 83.25ï¼‰">
        </div>
        <div class="button-group">
            <button onclick="addScore()">æäº¤æˆç»©</button>
            <button onclick="exportScores()">å¯¼å‡ºæˆç»©</button>
        </div>
        <div id="error" class="error"></div>
    </div>

    <script>
        let studentDatabase = {};
        let students = JSON.parse(localStorage.getItem('scores')) || [];

        // è¯»å–Excelæ–‡ä»¶
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                studentDatabase = {};
                jsonData.forEach(row => {
                    const id = String(row['å­¦å·']);
                    studentDatabase[id] = row['å§“å'];
                });

                alert(`æˆåŠŸåŠ è½½${Object.keys(studentDatabase).length}æ¡å­¦ç”Ÿæ•°æ®`);
            };

            reader.readAsArrayBuffer(file);
        });

        // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
        document.getElementById('studentId').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') document.getElementById('score').focus()
        });
        
        document.getElementById('score').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') addScore()
        });

        function addScore() {
            const studentId = document.getElementById('studentId').value;
            const score = parseFloat(document.getElementById('score').value);
            const errorDiv = document.getElementById('error');
            
            errorDiv.textContent = '';

            if (!studentId || isNaN(score)) {
                showError("è¯·å¡«å†™æœ‰æ•ˆçš„å­¦å·å’Œæˆç»©");
                return;
            }

            if (!studentDatabase[studentId]) {
                showError("å­¦å·ä¸å­˜åœ¨");
                return;
            }

            // æ£€æŸ¥è¯¥å­¦ç”Ÿæ˜¯å¦å·²æœ‰æˆç»©
            const existingStudentIndex = students.findIndex(s => s.id === studentId);
            
            if (existingStudentIndex !== -1) {
                const existingScore = students[existingStudentIndex].score;
                
                if (score > existingScore) {
                    // æ›´æ–°æˆç»©
                    students[existingStudentIndex].score = score;
                    alert(`æ›´æ–°æˆåŠŸï¼è¯¥å­¦ç”Ÿçš„æˆç»©ä» ${existingScore.toFixed(2)}% æé«˜åˆ° ${score.toFixed(2)}%`);
                } else {
                    showError("ç³»ç»Ÿä¸­å·²ç»æœ‰æ›´é«˜çš„æˆç»©äº†ï¼");
                    return;
                }
            } else {
                // æ·»åŠ æ–°æˆç»©
                students.push({
                    id: studentId,
                    name: studentDatabase[studentId],
                    score: score
                });
            }

            updateData();
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('studentId').value = '';
            document.getElementById('score').value = '';
            document.getElementById('studentId').focus();
        }

        function showError(message) {
            document.getElementById('error').textContent = message;
        }

        function updateData() {
            students.sort((a, b) => b.score - a.score);
            students = students.slice(0, 100);
            localStorage.setItem('scores', JSON.stringify(students));
            updateRanking();
        }

        function updateRanking() {
            const top5 = students.slice(0, 5);
            const container = document.getElementById('rankingBody');
            container.innerHTML = '';

            top5.forEach((student, index) => {
                const rank = index + 1;
                const item = document.createElement('div');
                item.className = 'ranking-item';

                item.innerHTML = `
                    <div class="rank ${getMedalClass(rank)}">
                        ${rank}${getMedalSymbol(rank)}
                    </div>
                    <div class="profile">
                        <div>${student.name}</div>
                        <div style="color: #888; font-size: 0.8em;">å­¦å·ï¼š${student.id}</div>
                    </div>
                    <div class="score">${student.score.toFixed(2)}%</div>
                    <div class="spacer"></div> <!-- æ·»åŠ è¿™ä¸ªç©ºdivä½œä¸ºå ä½ç¬¦ -->
                    <div class="delete-btn" onclick="deleteRecord('${student.id}', ${student.score})">Ã— åˆ é™¤</div>
                `;
                container.appendChild(item);
            });
        }

        function deleteRecord(id, score) {
            students = students.filter(s => !(s.id === id && s.score === score));
            updateData();
        }

        function getMedalClass(rank) {
            return [
                'medal-gold',
                'medal-silver',
                'medal-bronze',
                'medal-blue',
                'medal-purple'
            ][rank - 1] || '';
        }

        function getMedalSymbol(rank) {
            return ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ–ï¸', 'â­'][rank - 1] || '';
        }

        // å¯¼å‡ºæˆç»©åŠŸèƒ½
        function exportScores() {
            if (students.length === 0) {
                showError("æ²¡æœ‰æˆç»©è®°å½•å¯ä»¥å¯¼å‡º");
                return;
            }

            // åˆ›å»ºå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
            const ws = XLSX.utils.json_to_sheet(students.map((student, index) => ({
                'æ’å': index + 1,
                'å­¦å·': student.id,
                'å§“å': student.name,
                'æˆç»©': student.score.toFixed(2) + '%'
            })));

            // è®¾ç½®åˆ—å®½
            const colWidths = [
                { wch: 8 },  // æ’å
                { wch: 12 }, // å­¦å·
                { wch: 15 }, // å§“å
                { wch: 10 }  // æˆç»©
            ];
            ws['!cols'] = colWidths;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æˆç»©');

            // ç”Ÿæˆæ–‡ä»¶åï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
            const now = new Date();
            const fileName = `æˆç»©_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}.xlsx`;

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            
            // åˆ›å»ºä¸´æ—¶é“¾æ¥å¹¶è§¦å‘ä¸‹è½½
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            
            // æ¸…ç†
            setTimeout(() => {
                URL.revokeObjectURL(url);
                a.remove();
            }, 100);
        }

        // åˆå§‹åŒ–æ˜¾ç¤º
        updateRanking();
    </script>
</body>
</html>
